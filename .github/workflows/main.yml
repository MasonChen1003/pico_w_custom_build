name: Build Pico W Firmware (Driver + 1 Font)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 安裝編譯工具
    - name: Install Arm GNU Toolchain
      uses: carlosperate/arm-none-eabi-gcc-action@v1
      with:
        release: '13.2.Rel1'

    - name: Install CMake and Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    # 2. 下載 MicroPython 原始碼
    - name: Checkout MicroPython
      uses: actions/checkout@v4
      with:
        repository: micropython/micropython
        path: micropython
        submodules: false 

    # 3. 下載 ST7789 驅動 (C 模組)
    - name: Checkout ST7789 Driver
      uses: actions/checkout@v4
      with:
        repository: russhughes/st7789_mpy
        path: st7789_mpy
 
    # 4. 準備字型檔 (修正路徑：從 fonts/bitmap 下載 vga2_bold_16x32.py)
    - name: Prepare Single Font
      run: |
        mkdir -p custom_lib
        
        # 使用您找到的正確路徑
        wget https://raw.githubusercontent.com/russhughes/st7789_mpy/master/fonts/bitmap/vga2_bold_16x32.py -O custom_lib/vga2_bold_16x32.py
        # 2. ✨ 最終版 _boot.py (基於您查到的原始碼 + 亮燈功能)
        # 直接覆蓋 micropython/ports/rp2/modules/_boot.py
        
        cat <<EOF > micropython/ports/rp2/modules/_boot.py
        import vfs
        import machine
        import rp2

        # --- 1. 電源指示燈邏輯 (插隊在掛載硬碟前執行) ---
        try:
            # 針對 Pico W (LED 接在無線晶片)
            # 注意：如果無線晶片還沒 ready，這行可能會失敗，所以用 try 包起來
            machine.Pin("LED", machine.Pin.OUT).value(1)
        except:
            try:
                # 針對一般 Pico (LED 接在 GPIO 25)
                machine.Pin(25, machine.Pin.OUT).value(1)
            except:
                pass

        # --- 2. 系統掛載邏輯 (您的正確代碼) ---
        # 嘗試掛載檔案系統，如果失敗(例如全新的板子)就格式化
        bdev = rp2.Flash()
        try:
            fs = vfs.VfsLfs2(bdev, progsize=256)
        except:
            # 如果掛載失敗，執行格式化 (mkfs)
            vfs.VfsLfs2.mkfs(bdev, progsize=256)
            fs = vfs.VfsLfs2(bdev, progsize=256)
        
        vfs.mount(fs, "/")

        # --- 3. 清理記憶體 ---
        del vfs, bdev, fs, machine, rp2
        EOF

        # 3. 建立清單
        # ✅ 正確的寫法 (引入 Pico W 專屬清單，這才會包含 ssl, aioble, urequests)
        echo 'include("$(PORT_DIR)/boards/RPI_PICO_W/manifest.py")' > my_manifest.py        
        echo 'freeze("${{ github.workspace }}/custom_lib")' >> my_manifest.py
        
    # 5. 編譯 mpy-cross (編譯器)
    - name: Build mpy-cross
      run: |
        cd micropython
        git submodule update --init lib/pico-sdk lib/cyw43-driver lib/lwip lib/mbedtls lib/micropython-lib lib/tinyusb lib/btstack
        make -C mpy-cross

    # 6. 編譯韌體 (驅動 + 指定字型)
    - name: Build Firmware
      run: |
        cd micropython/ports/rp2
        make BOARD=RPI_PICO_W clean
        
        make BOARD=RPI_PICO_W \
             USER_C_MODULES=${{ github.workspace }}/st7789_mpy/st7789/micropython.cmake \
             FROZEN_MANIFEST=${{ github.workspace }}/my_manifest.py

    # 7. 上傳結果
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: firmware-pico-w-st7789-font
        path: micropython/ports/rp2/build-RPI_PICO_W/firmware.uf2
